#!/usr/bin/with-contenv bashio

AUTH_KEY=$(bashio::config 'auth_key')

echo "[INFO] Starting tailscaled..."
/usr/local/bin/tailscaled &

TAILSCALED_PID=$!

# Esperar a que tailscaled estÃ© listo
for i in $(seq 1 20); do
  if /usr/local/bin/tailscale status &>/dev/null; then
    echo "[INFO] tailscaled ready"
    break
  fi
  echo "[INFO] Waiting for tailscaled... ($i/20)"
  sleep 2
done

echo "[INFO] Connecting to Tailscale..."
/usr/local/bin/tailscale up --authkey "$AUTH_KEY" --hostname hass-tailscale

echo "[INFO] Tailscale IP:"
/usr/local/bin/tailscale ip -4 || echo "[WARN] Could not get IP"

# Mantener el proceso vivo mientras tailscaled funcione
while kill -0 "$TAILSCALED_PID" 2>/dev/null; do
  sleep 10
done

echo "[ERROR] tailscaled exited"
exit 1
